name: Deploy Next.js to Cloudflare Pages (via Wrangler)

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # 1. SETUP NODE.JS (Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng v√† cache pnpm)
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          # cache: 'pnpm' 
          
      # 2. C√ÄI ƒê·∫∂T PNPM EXECUTABLE
      - name: üì¶ Install pnpm executable
        uses: pnpm/action-setup@v3
        with:
          version: 8 
          run_install: false

      # 3. C√ÄI ƒê·∫∂T DEPENDENCIES & BUILD (S·ª≠ d·ª•ng pnpm)
      - name: üõ†Ô∏è Install dependencies and Run Build
        run: |
          pnpm install
          pnpm run build
        
      # 4. TRI·ªÇN KHAI B·∫∞NG WRANGLER (Thay th·∫ø cho Pages Action c≈©)
      # B∆∞·ªõc n√†y s·∫Ω t·∫£i l√™n th∆∞ m·ª•c output (.open-next) l√™n Cloudflare Pages
      - name: üöÄ Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          # Th∆∞ m·ª•c OpenNext t·∫°o ra, ch·ª©a c·∫£ Worker v√† Assets
          workingDirectory: .open-next
          
          # L·ªánh tri·ªÉn khai Pages s·ª≠ d·ª•ng wrangler (Direct Upload)
          command: pages deploy .open-next/assets --project-name ptit
          
        env:
          # C·∫ßn thi·∫øt cho Wrangler x√°c th·ª±c
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}