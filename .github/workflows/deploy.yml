name: Deploy Next.js to Cloudflare Pages (via Wrangler)

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4

      # 1. SETUP NODE.JS
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          
      # 2. C√ÄI ƒê·∫∂T PNPM EXECUTABLE
      - name: üì¶ Install pnpm executable
        uses: pnpm/action-setup@v3
        with:
          version: 10.24.0
          run_install: false

      # 3. BUILD (PH√Å V·ª† V√íNG L·∫∂P ƒê·ªÜ QUY)
      - name: üõ†Ô∏è Install dependencies and Run OpenNext Build
        run: |
          pnpm install --frozen-lockfile
          
          # Ch·∫°y OpenNext v·ªõi bi·∫øn m√¥i tr∆∞·ªùng ch·ªâ ƒë·ªãnh l·ªánh build Next.js g·ªëc
          OPEN_NEXT_BUILD_CMD="pnpm run build" pnpm run open-next-build
        
        env:
          # C·∫ßn thi·∫øt ƒë·ªÉ OpenNext s·ª≠ d·ª•ng phi√™n b·∫£n Node ph√π h·ª£p
          NODE_VERSION: 20

      # 4. TRI·ªÇN KHAI B·∫∞NG WRANGLER (Direct Upload)
      - name: Deploy to Cloudflare Pages
        run: npx --yes wrangler pages deploy .open-next/assets \
              --project-name ptit
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}